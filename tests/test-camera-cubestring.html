<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Cubestring Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #2196F3;
            background-color: #f9f9f9;
        }
        .test-case h3 {
            margin-top: 0;
            color: #2196F3;
        }
        .pass {
            color: #4CAF50;
            font-weight: bold;
        }
        .fail {
            color: #f44336;
            font-weight: bold;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            font-family: monospace;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .summary {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Camera Cubestring Integration Test</h1>
    <p>Testing camera capture integration with cubestring-based state management</p>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <div class="summary" id="summary" style="display: none;">
        <h2>Test Summary</h2>
        <div id="summary-content"></div>
    </div>

    <script type="module">
        import { CubeState } from '../scripts/cube-state.js';
        import { CameraCapture } from '../scripts/camera-capture.js';

        let testResults = [];
        let cubeState;
        let cameraCapture;

        // Initialize test environment
        function initializeTestEnvironment() {
            cubeState = new CubeState();
            cameraCapture = new CameraCapture(cubeState);
            testResults = [];
        }

        // Test helper functions
        function assert(condition, message) {
            if (condition) {
                return { pass: true, message };
            } else {
                return { pass: false, message };
            }
        }

        function assertEqual(actual, expected, message) {
            if (actual === expected) {
                return { pass: true, message: `${message} - Got: ${actual}` };
            } else {
                return { pass: false, message: `${message} - Expected: ${expected}, Got: ${actual}` };
            }
        }

        function assertArrayEqual(actual, expected, message) {
            const actualStr = JSON.stringify(actual);
            const expectedStr = JSON.stringify(expected);
            if (actualStr === expectedStr) {
                return { pass: true, message: `${message}` };
            } else {
                return { pass: false, message: `${message} - Expected: ${expectedStr}, Got: ${actualStr}` };
            }
        }

        // Test 1: convertColorsToCubestring helper method
        function testConvertColorsToCubestring() {
            const testName = "Test 1: convertColorsToCubestring Helper Method";
            const results = [];

            try {
                // Test case 1: Valid color array
                const colors1 = ['White', 'Red', 'Green', 'Yellow', 'Orange', 'Blue', 'White', 'Red', 'Green'];
                const result1 = cameraCapture.convertColorsToCubestring(colors1, 'front');
                results.push(assertEqual(result1, 'URFUDLBUR', 'Converts valid color array correctly'));

                // Test case 2: All same color
                const colors2 = ['White', 'White', 'White', 'White', 'White', 'White', 'White', 'White', 'White'];
                const result2 = cameraCapture.convertColorsToCubestring(colors2, 'top');
                results.push(assertEqual(result2, 'UUUUUUUUU', 'Converts all white colors correctly'));

                // Test case 3: Unknown color handling
                const colors3 = ['White', 'Unknown', 'Green', 'Yellow', 'Orange', 'Blue', 'White', 'Red', 'Green'];
                const result3 = cameraCapture.convertColorsToCubestring(colors3, 'front');
                results.push(assert(result3.includes('U'), 'Handles unknown colors by defaulting to U'));

                // Test case 4: Invalid input - wrong length
                const colors4 = ['White', 'Red', 'Green'];
                const result4 = cameraCapture.convertColorsToCubestring(colors4, 'front');
                results.push(assertEqual(result4, null, 'Returns null for invalid array length'));

                // Test case 5: Invalid input - not an array
                const result5 = cameraCapture.convertColorsToCubestring('not an array', 'front');
                results.push(assertEqual(result5, null, 'Returns null for non-array input'));

            } catch (error) {
                results.push({ pass: false, message: `Exception: ${error.message}` });
            }

            return { testName, results };
        }

        // Test 2: applyDetectedColors method
        function testApplyDetectedColors() {
            const testName = "Test 2: applyDetectedColors Method";
            const results = [];

            try {
                // Reset cube to solved state
                cubeState.reset();
                const initialCubestring = cubeState.getCubestring();
                results.push(assertEqual(initialCubestring, 'UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB', 'Cube starts in solved state'));

                // Test case 1: Apply colors to front face
                const frontColors = ['Red', 'Red', 'Red', 'Red', 'Red', 'Red', 'Red', 'Red', 'Red'];
                cameraCapture.applyDetectedColors(frontColors, 'front');
                
                const frontFaceColors = cubeState.getFaceColors('front');
                const expectedFrontFace = [['R', 'R', 'R'], ['R', 'R', 'R'], ['R', 'R', 'R']];
                results.push(assertArrayEqual(frontFaceColors, expectedFrontFace, 'Front face updated correctly'));

                // Test case 2: Apply colors to top face
                const topColors = ['White', 'White', 'White', 'White', 'White', 'White', 'White', 'White', 'White'];
                cameraCapture.applyDetectedColors(topColors, 'top');
                
                const topFaceColors = cubeState.getFaceColors('top');
                const expectedTopFace = [['U', 'U', 'U'], ['U', 'U', 'U'], ['U', 'U', 'U']];
                results.push(assertArrayEqual(topFaceColors, expectedTopFace, 'Top face updated correctly'));

                // Test case 3: Apply mixed colors to right face
                const rightColors = ['Red', 'Green', 'Blue', 'White', 'Yellow', 'Orange', 'Red', 'Green', 'Blue'];
                cameraCapture.applyDetectedColors(rightColors, 'right');
                
                const rightFaceColors = cubeState.getFaceColors('right');
                const expectedRightFace = [['R', 'F', 'B'], ['U', 'D', 'L'], ['R', 'F', 'B']];
                results.push(assertArrayEqual(rightFaceColors, expectedRightFace, 'Right face updated with mixed colors'));

                // Test case 4: Verify cubestring is updated
                const currentCubestring = cubeState.getCubestring();
                results.push(assert(currentCubestring !== initialCubestring, 'Cubestring changed after applying colors'));
                results.push(assertEqual(currentCubestring.length, 54, 'Cubestring maintains correct length'));

                // Test case 5: Invalid input handling
                cameraCapture.applyDetectedColors(null, 'front');
                results.push(assert(true, 'Handles null colors gracefully'));

                cameraCapture.applyDetectedColors(['Red'], 'front');
                results.push(assert(true, 'Handles invalid array length gracefully'));

            } catch (error) {
                results.push({ pass: false, message: `Exception: ${error.message}` });
            }

            return { testName, results };
        }

        // Test 3: Integration with cubestring state
        function testCubestringIntegration() {
            const testName = "Test 3: Cubestring Integration";
            const results = [];

            try {
                // Reset cube
                cubeState.reset();

                // Apply colors to all faces
                const faceColors = {
                    'top': ['White', 'White', 'White', 'White', 'White', 'White', 'White', 'White', 'White'],
                    'right': ['Red', 'Red', 'Red', 'Red', 'Red', 'Red', 'Red', 'Red', 'Red'],
                    'front': ['Green', 'Green', 'Green', 'Green', 'Green', 'Green', 'Green', 'Green', 'Green'],
                    'bottom': ['Yellow', 'Yellow', 'Yellow', 'Yellow', 'Yellow', 'Yellow', 'Yellow', 'Yellow', 'Yellow'],
                    'left': ['Orange', 'Orange', 'Orange', 'Orange', 'Orange', 'Orange', 'Orange', 'Orange', 'Orange'],
                    'back': ['Blue', 'Blue', 'Blue', 'Blue', 'Blue', 'Blue', 'Blue', 'Blue', 'Blue']
                };

                // Apply colors to each face
                for (const [face, colors] of Object.entries(faceColors)) {
                    cameraCapture.applyDetectedColors(colors, face);
                }

                // Verify final cubestring
                const finalCubestring = cubeState.getCubestring();
                const expectedCubestring = 'UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB';
                results.push(assertEqual(finalCubestring, expectedCubestring, 'Full cube scan produces solved cubestring'));

                // Verify cubestring is valid
                results.push(assert(cubeState.isValidCubestring(finalCubestring), 'Final cubestring is valid'));

                // Verify each color appears exactly 9 times
                const colorCounts = {};
                for (const char of finalCubestring) {
                    colorCounts[char] = (colorCounts[char] || 0) + 1;
                }
                
                const validColors = ['U', 'R', 'F', 'D', 'L', 'B'];
                let allCountsCorrect = true;
                for (const color of validColors) {
                    if (colorCounts[color] !== 9) {
                        allCountsCorrect = false;
                        break;
                    }
                }
                results.push(assert(allCountsCorrect, 'Each color appears exactly 9 times'));

            } catch (error) {
                results.push({ pass: false, message: `Exception: ${error.message}` });
            }

            return { testName, results };
        }

        // Test 4: Performance test
        function testPerformance() {
            const testName = "Test 4: Performance Test";
            const results = [];

            try {
                const colors = ['Red', 'Green', 'Blue', 'White', 'Yellow', 'Orange', 'Red', 'Green', 'Blue'];
                
                // Measure time for 100 color applications
                const iterations = 100;
                const startTime = performance.now();
                
                for (let i = 0; i < iterations; i++) {
                    cameraCapture.applyDetectedColors(colors, 'front');
                }
                
                const endTime = performance.now();
                const totalTime = endTime - startTime;
                const avgTime = totalTime / iterations;
                
                results.push(assert(avgTime < 10, `Average time per operation: ${avgTime.toFixed(2)}ms (should be < 10ms)`));
                results.push(assert(totalTime < 1000, `Total time for ${iterations} operations: ${totalTime.toFixed(2)}ms (should be < 1000ms)`));

            } catch (error) {
                results.push({ pass: false, message: `Exception: ${error.message}` });
            }

            return { testName, results };
        }

        // Run all tests
        window.runAllTests = function() {
            clearResults();
            initializeTestEnvironment();

            const tests = [
                testConvertColorsToCubestring,
                testApplyDetectedColors,
                testCubestringIntegration,
                testPerformance
            ];

            let totalTests = 0;
            let passedTests = 0;

            tests.forEach(test => {
                const { testName, results } = test();
                testResults.push({ testName, results });
                
                results.forEach(result => {
                    totalTests++;
                    if (result.pass) passedTests++;
                });
            });

            displayResults();
            displaySummary(totalTests, passedTests);
        };

        // Display results
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            testResults.forEach(({ testName, results }) => {
                const testSection = document.createElement('div');
                testSection.className = 'test-section';
                
                const testTitle = document.createElement('h2');
                testTitle.textContent = testName;
                testSection.appendChild(testTitle);

                results.forEach(result => {
                    const testCase = document.createElement('div');
                    testCase.className = 'test-case';
                    
                    const status = document.createElement('span');
                    status.className = result.pass ? 'pass' : 'fail';
                    status.textContent = result.pass ? '✓ PASS' : '✗ FAIL';
                    
                    const message = document.createElement('span');
                    message.textContent = ': ' + result.message;
                    
                    testCase.appendChild(status);
                    testCase.appendChild(message);
                    testSection.appendChild(testCase);
                });

                resultsDiv.appendChild(testSection);
            });
        }

        // Display summary
        function displaySummary(total, passed) {
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            
            const percentage = ((passed / total) * 100).toFixed(1);
            const status = passed === total ? 'pass' : 'fail';
            
            summaryContent.innerHTML = `
                <p class="${status}">
                    ${passed} / ${total} tests passed (${percentage}%)
                </p>
                ${passed === total ? 
                    '<p style="color: #4CAF50;">✓ All tests passed! Camera cubestring integration is working correctly.</p>' :
                    '<p style="color: #f44336;">✗ Some tests failed. Please review the results above.</p>'
                }
            `;
            
            summaryDiv.style.display = 'block';
        }

        // Clear results
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            testResults = [];
        };

        // Auto-run tests on load
        window.addEventListener('load', () => {
            console.log('Camera Cubestring Integration Test loaded');
            runAllTests();
        });
    </script>
</body>
</html>
