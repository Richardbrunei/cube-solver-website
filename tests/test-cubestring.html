<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cubestring Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        h2 {
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Cubestring Implementation Test</h1>
    <div id="test-results"></div>

    <script type="module">
        import { CubeState } from '../scripts/cube-state.js';

        const resultsDiv = document.getElementById('test-results');

        function addTestResult(testName, passed, message = '') {
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <strong>${passed ? '✓' : '✗'} ${testName}</strong>
                ${message ? `<br><small>${message}</small>` : ''}
            `;
            resultsDiv.appendChild(div);
        }

        // Run tests
        async function runTests() {
            const cubeState = new CubeState();

            // Test 1: Cubestring property exists and is initialized
            addTestResult(
                'Cubestring property initialized',
                cubeState.cubestring === "UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB",
                `Expected: UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB, Got: ${cubeState.cubestring}`
            );

            // Test 2: getCubestring() method works
            const cubestring = cubeState.getCubestring();
            addTestResult(
                'getCubestring() returns correct value',
                cubestring === "UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB",
                `Got: ${cubestring}`
            );

            // Test 3: isValidCubestring() validates correct cubestring
            const validCubestring = "UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB";
            addTestResult(
                'isValidCubestring() accepts valid cubestring',
                cubeState.isValidCubestring(validCubestring) === true,
                `Tested: ${validCubestring}`
            );

            // Test 4: isValidCubestring() rejects invalid length
            const invalidLength = "UUUUUUUUU";
            addTestResult(
                'isValidCubestring() rejects invalid length',
                cubeState.isValidCubestring(invalidLength) === false,
                `Tested: ${invalidLength} (length: ${invalidLength.length})`
            );

            // Test 5: isValidCubestring() rejects invalid characters
            const invalidChars = "UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBX";
            addTestResult(
                'isValidCubestring() rejects invalid characters',
                cubeState.isValidCubestring(invalidChars) === false,
                `Tested: ${invalidChars} (contains 'X')`
            );

            // Test 6: isValidCubestring() rejects invalid color distribution
            const invalidDistribution = "UUUUUUUUUUUUUUUUUUFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB";
            addTestResult(
                'isValidCubestring() rejects invalid color distribution',
                cubeState.isValidCubestring(invalidDistribution) === false,
                `Tested: ${invalidDistribution} (too many U's)`
            );

            // Test 7: setCubestring() updates cubestring
            const newCubestring = "UUUUUUUUURRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBBR";
            try {
                cubeState.setCubestring(newCubestring);
                addTestResult(
                    'setCubestring() updates cubestring',
                    cubeState.getCubestring() === newCubestring,
                    `Set to: ${newCubestring}`
                );
            } catch (error) {
                addTestResult(
                    'setCubestring() updates cubestring',
                    false,
                    `Error: ${error.message}`
                );
            }

            // Test 8: setCubestring() rejects invalid cubestring
            try {
                cubeState.setCubestring("INVALID");
                addTestResult(
                    'setCubestring() rejects invalid cubestring',
                    false,
                    'Should have thrown an error'
                );
            } catch (error) {
                addTestResult(
                    'setCubestring() rejects invalid cubestring',
                    error.message.includes('Invalid cubestring'),
                    `Error message: ${error.message}`
                );
            }

            // Test 9: isValidCubestring() handles null/undefined
            addTestResult(
                'isValidCubestring() handles null',
                cubeState.isValidCubestring(null) === false,
                'Tested: null'
            );

            addTestResult(
                'isValidCubestring() handles undefined',
                cubeState.isValidCubestring(undefined) === false,
                'Tested: undefined'
            );

            // Test 10: Cubestring length is exactly 54
            addTestResult(
                'Cubestring length is exactly 54',
                cubeState.getCubestring().length === 54,
                `Length: ${cubeState.getCubestring().length}`
            );

            // Test 11: All valid characters are accepted
            const allValidChars = "UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB";
            addTestResult(
                'All valid backend COLOR_TO_CUBE characters accepted (U,R,F,D,L,B)',
                cubeState.isValidCubestring(allValidChars) === true,
                'Characters: U, R, F, D, L, B'
            );

            // Test 12: Change notification on setCubestring
            let changeNotified = false;
            cubeState.addChangeListener((event) => {
                if (event.type === 'cubestringUpdated') {
                    changeNotified = true;
                }
            });
            cubeState.setCubestring("UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB");
            addTestResult(
                'setCubestring() triggers change notification',
                changeNotified === true,
                'Event type: cubestringUpdated'
            );

            // Test 13: stringPositionToFaceCoords() - top face
            const coords0 = cubeState.stringPositionToFaceCoords(0);
            addTestResult(
                'stringPositionToFaceCoords(0) returns top face, row 0, col 0',
                coords0.face === 'top' && coords0.row === 0 && coords0.col === 0,
                `Got: face=${coords0.face}, row=${coords0.row}, col=${coords0.col}`
            );

            // Test 14: stringPositionToFaceCoords() - right face
            const coords9 = cubeState.stringPositionToFaceCoords(9);
            addTestResult(
                'stringPositionToFaceCoords(9) returns right face, row 0, col 0',
                coords9.face === 'right' && coords9.row === 0 && coords9.col === 0,
                `Got: face=${coords9.face}, row=${coords9.row}, col=${coords9.col}`
            );

            // Test 15: stringPositionToFaceCoords() - front face middle
            const coords22 = cubeState.stringPositionToFaceCoords(22);
            addTestResult(
                'stringPositionToFaceCoords(22) returns front face, row 1, col 1',
                coords22.face === 'front' && coords22.row === 1 && coords22.col === 1,
                `Got: face=${coords22.face}, row=${coords22.row}, col=${coords22.col}`
            );

            // Test 16: stringPositionToFaceCoords() - back face last
            const coords53 = cubeState.stringPositionToFaceCoords(53);
            addTestResult(
                'stringPositionToFaceCoords(53) returns back face, row 2, col 2',
                coords53.face === 'back' && coords53.row === 2 && coords53.col === 2,
                `Got: face=${coords53.face}, row=${coords53.row}, col=${coords53.col}`
            );

            // Test 17: stringPositionToFaceCoords() - invalid position
            try {
                cubeState.stringPositionToFaceCoords(54);
                addTestResult(
                    'stringPositionToFaceCoords() rejects position > 53',
                    false,
                    'Should have thrown an error'
                );
            } catch (error) {
                addTestResult(
                    'stringPositionToFaceCoords() rejects position > 53',
                    error.message.includes('Invalid position'),
                    `Error: ${error.message}`
                );
            }

            // Test 18: faceCoordsToStringPosition() - top face
            const pos0 = cubeState.faceCoordsToStringPosition('top', 0, 0);
            addTestResult(
                'faceCoordsToStringPosition(top, 0, 0) returns 0',
                pos0 === 0,
                `Got: ${pos0}`
            );

            // Test 19: faceCoordsToStringPosition() - right face
            const pos9 = cubeState.faceCoordsToStringPosition('right', 0, 0);
            addTestResult(
                'faceCoordsToStringPosition(right, 0, 0) returns 9',
                pos9 === 9,
                `Got: ${pos9}`
            );

            // Test 20: faceCoordsToStringPosition() - front face middle
            const pos22 = cubeState.faceCoordsToStringPosition('front', 1, 1);
            addTestResult(
                'faceCoordsToStringPosition(front, 1, 1) returns 22',
                pos22 === 22,
                `Got: ${pos22}`
            );

            // Test 21: faceCoordsToStringPosition() - back face last
            const pos53 = cubeState.faceCoordsToStringPosition('back', 2, 2);
            addTestResult(
                'faceCoordsToStringPosition(back, 2, 2) returns 53',
                pos53 === 53,
                `Got: ${pos53}`
            );

            // Test 22: faceCoordsToStringPosition() - invalid face
            try {
                cubeState.faceCoordsToStringPosition('invalid', 0, 0);
                addTestResult(
                    'faceCoordsToStringPosition() rejects invalid face',
                    false,
                    'Should have thrown an error'
                );
            } catch (error) {
                addTestResult(
                    'faceCoordsToStringPosition() rejects invalid face',
                    error.message.includes('Invalid face name'),
                    `Error: ${error.message}`
                );
            }

            // Test 23: extractFaceString() - top face
            const topFace = cubeState.extractFaceString(cubeState.getCubestring(), 'top');
            addTestResult(
                'extractFaceString() extracts top face (9 U characters)',
                topFace === 'UUUUUUUUU',
                `Got: ${topFace}`
            );

            // Test 24: extractFaceString() - right face
            const rightFace = cubeState.extractFaceString(cubeState.getCubestring(), 'right');
            addTestResult(
                'extractFaceString() extracts right face (9 R characters)',
                rightFace === 'RRRRRRRRR',
                `Got: ${rightFace}`
            );

            // Test 25: updateFaceInString() - update front face
            const updatedString = cubeState.updateFaceInString(
                cubeState.getCubestring(),
                'front',
                'DDDDDDDDD'
            );
            addTestResult(
                'updateFaceInString() updates front face',
                updatedString.substring(18, 27) === 'DDDDDDDDD',
                `Front face in result: ${updatedString.substring(18, 27)}`
            );

            // Test 26: updateFaceInString() - preserves other faces
            const preserved = cubeState.updateFaceInString(
                cubeState.getCubestring(),
                'front',
                'DDDDDDDDD'
            );
            addTestResult(
                'updateFaceInString() preserves other faces',
                preserved.substring(0, 9) === 'UUUUUUUUU' && preserved.substring(9, 18) === 'RRRRRRRRR',
                `Top: ${preserved.substring(0, 9)}, Right: ${preserved.substring(9, 18)}`
            );

            // Test 27: getStickerFromString() - position 0
            const sticker0 = cubeState.getStickerFromString(0);
            addTestResult(
                'getStickerFromString(0) returns U',
                sticker0 === 'U',
                `Got: ${sticker0}`
            );

            // Test 28: getStickerFromString() - position 22 (front center)
            const sticker22 = cubeState.getStickerFromString(22);
            addTestResult(
                'getStickerFromString(22) returns F',
                sticker22 === 'F',
                `Got: ${sticker22}`
            );

            // Test 29: setStickerInString() - update position 0
            cubeState.setCubestring("UUUUUUUUURRRRRRRRRFFFFFFFFFDDDDDDDDDLLLLLLLLLBBBBBBBBB");
            cubeState.setStickerInString(0, 'R');
            addTestResult(
                'setStickerInString(0, R) updates position 0',
                cubeState.getCubestring()[0] === 'R',
                `Position 0: ${cubeState.getCubestring()[0]}`
            );

            // Test 30: setStickerInString() - triggers change notification
            let stickerChangeNotified = false;
            cubeState.addChangeListener((event) => {
                if (event.type === 'stickerUpdated') {
                    stickerChangeNotified = true;
                }
            });
            cubeState.setStickerInString(1, 'F');
            addTestResult(
                'setStickerInString() triggers change notification',
                stickerChangeNotified === true,
                'Event type: stickerUpdated'
            );

            // Test 31: Round-trip conversion
            const originalPos = 22;
            const coords = cubeState.stringPositionToFaceCoords(originalPos);
            const convertedPos = cubeState.faceCoordsToStringPosition(coords.face, coords.row, coords.col);
            addTestResult(
                'Round-trip conversion (position → coords → position)',
                originalPos === convertedPos,
                `Original: ${originalPos}, Converted: ${convertedPos}`
            );

            console.log('All tests completed!');
        }

        runTests();
    </script>
</body>
</html>
